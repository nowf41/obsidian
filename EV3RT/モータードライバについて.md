## 概要
LEGO Educationが用意したLinuxドライバを、toppersがLinux依存部を書き換えて使用している。
対象となる全ファイルが`hrp3/target/ev3_gcc/drivers/motor/`配下にある。
同ディレクトリ直下のmotor_dri.cfgがSVCを登録している。
## 呼び出し
### 共通部
asmテンプレート: `"svc 1"`
`r0`: cmd (voidポインタ)
`r1`: size (cmdに指定したポインタのサイズ)
`r2-r4`: 0
`r5`: FNCD (23)
cmd実体の先頭8bitが命令区分を表す。
### 命令一覧
#### opPROGRAM_STOP (0x02)
概要: プログラム停止時のハンドラ。モータを停止させる。ユーザーコードからの直接呼び出しは望ましくない。
#### opPROGRAM_START (0x03)
概要: プログラム開始時のハンドラ。モータ状態を初期化する。ユーザーコードからの直接呼び出しは望ましくない。
#### opOUTPUT_SET_TYPE (0xA1)
概要: モータポートにモータを接続/切断する。
命令: 40bit
> 8bit 0xA1
> 8bit モータポートAに接続するモータの種類 [^1]
> 8bit モータポートBに接続するモータの種類 [^1]
> 8bit モータポートCに接続するモータの種類 [^1]
> 8bit モータポートDに接続するモータの種類 [^1]

[^1]: `TACHO`は0x07、`MINITACHO`は0x08。Toppers純正のev3apiの実装を考慮すると、NXTモータとEV3-Lモータは`TACHO`、EV3-Mモータは`MINITACHO`と推測される。それ以外の値を指定すると空きポート指定(=切断)として扱われる。
#### opOUTPUT_RESET (0xA2)
概要: 出力として使用されているモータのタコカウンタをリセットする。
命令: 
> 8bit 0xA2
> 4bit (パディング)
> 4bit 適用対象モータのフラグ [^3]

#### opOUTPUT_CLR_COUNT (0xB2)
概要: モータが回転数センサとして使用されている場合に、タコメータをリセットする。 
命令: 
> 8bit 0xB2
> 4bit (パディング)
> 4bit 適用対象モータのフラグ [^3]

#### opOUTPUT_STOP (0xA3)
概要: モータを停止させる。
命令:
> 8bit 0xA3
> 4bit (パディング)
> 4bit 適用対象モータのフラグ
> 8bit モータの停止モード [^4]

[^4]: 1ならモータにブレーキを掛け、0ならモータを自由にする

#### opOUTPUT_POWER (0xA4)
概要: モータのデューティ比を直接指定する。モータは始動しない。
命令:
> 8bit 0xA4
> 4bit (パディング)
> 4bit 適用対象モータのフラグ [^3]
> 8bit モータのデューティ比 (符号付き8bit整数、$-100 \leq x \leq 100$)

#### opOUTPUT_SPEED (0xA5)
概要: 調整されたモータ速度を指定する。モータは始動しない。
命令:
> 8bit 0xA5
> 4bit (パディング)
> 4bit 適用対象モータのフラグ [^3]
> 8bit モータの速度 (符号付き8bit整数、$-100 \leq x \leq 100$)

#### opOUTPUT_START (0xA6)
概要: 指定されたモータを起動する。
命令:
> 8bit 0xA6
> 4bit (パディング)
> 4bit 適用対象モータのフラグ [^3]

#### opOUTPUT_POLARITY (0xA7)
概要: モータの極性を指定する。なお、この命令を使用しなくとも速度指定などで負の値はを与えることは可能であるため、通常は使用する必要はない。
命令:
> 8bit 0xA6
> 4bit (パディング)
> 4bit 適用対象モータのフラグ [^3]
> 8bit 極性指定子[^5] (符号付き8bit整数)

#### opOUTPUT_POSITION (0xAB)
概要: 空命令
命令:
> 8bit 0xAB

#### opOUTPUT_STEP_POWER (0xAC)
概要: 未調整のモータ[^6]に対して、タコメータに基づく台形制御を行う。
命令:
> 128bit STEPPOWER構造体

#### opOUTPUT_TIME_POWER (0xAD)
概要: 未調整のモータに対して、時間指定による台形制御を行う。
命令:
> 128bit TIMEPOWER構造体

#### opOUTPUT_STEP_SPEED (0xAE)
概要: 調整されたモータ[^7]に対して、タコメータに基づく台形制御を行う。
命令:
> 128bit STEPSPEED構造体

#### opOUTPUT_TIME_SPEED (0xAF)
概要: 調整されたモータに対して、時間指定による台形制御を行う。
命令:
> 128bit TIMESPEED構造体

#### opOUTPUT_STEP_SYNC (0xB0)
概要: 調整された2つのモータを同期させ、タコメータの値で指定された区間を回転させる。モータ速度は目標値まで即座にジャンプする。
また、並行で2組のモータを動かすことは不可能であると思われる。
命令:
> 80bit STEPSYNC構造体

#### opOUTPUT_TIME_SYNC (0xB1)
概要: 調整された2つのモータを同期させ、で指定された区間を回転させる。
モータ速度は目標値まで即座にジャンプする。
また、並行で2組のモータを動かすことは不可能であると思われる。
命令:
> 80bit TIMESYNC構造体

## 構造体
#### STEPPOWER
```
typedef struct
{
  DATA8   Cmd;   // 常に0xAC
  DATA8   Nos;   // [^3]
  DATA8   Power; // 到達PWMを指定.
  DATA32  Step1; // 加速にかける距離[deg]
  DATA32  Step2; // 等速にかける距離[deg]
  DATA32  Step3; // 減速にかける距離[deg]
  DATA8   Brake; // ブレーキをかける(1)かそのまま滑走する(0)かを指定.
} STEPPOWER;
```
#### TIMEPOWER
```
typedef struct
{
  DATA8   Cmd;   // 常に0xAD
  DATA8   Nos;   // [^3]
  DATA8   Power; // 到達PWMを指定.
  DATA32  Time1; // 加速にかける時間 [msec]
  DATA32  Time2; // 等速にかける時間 [msec]
  DATA32  Time3; // 減速にかける時間 [msec]
  DATA8   Brake; // ブレーキをかける(1)かそのまま滑走する(0)かを指定.
} TIMEPOWER;
```
#### STEPSPEED
```
typedef struct
{
  DATA8   Cmd;   // 常に0xAE
  DATA8   Nos;   // [^3]
  DATA8   Speed; // 到達速度を指定. なお、PWMではない.
  DATA32  Step1; // 加速にかける距離[deg]
  DATA32  Step2; // 等速にかける距離[deg]
  DATA32  Step3; // 減速にかける距離[deg]
  DATA8   Brake; // ブレーキをかける(1)かそのまま滑走する(0)かを指定.
} STEPSPEED;
```
#### TIMESPEED
```
typedef struct
{
  DATA8   Cmd;   // 常に0xAF
  DATA8   Nos;   // [^3]
  DATA8   Speed; // 到達速度を指定. なお、PWMではない.
  DATA32  Time1; // 加速にかける時間[msec]
  DATA32  Time2; // 等速にかける時間[msec]
  DATA32  Time3; // 減速にかける時間[msec]
  DATA8   Brake; // ブレーキをかける(1)かそのまま滑走する(0)かを指定.
} TIMESPEED;
```
#### STEPSYNC
```
typedef struct
{
  DATA8   Cmd;   // 常に0xB0
  DATA8   Nos;   // [^3] なお、立っているビットは丁度2個でなければならない.
  DATA8   Speed; // 到達速度を指定. なお、PWMではない.
  DATA16  Turn;  // 回転率. -200 <= x <= 200. |x| > 100では両方のモータが逆方向に回転する.
  DATA32  Step;  // 走行距離 [deg] なお、0で無限に走行.
  DATA8   Brake; // ブレーキをかける(1)かそのまま滑走する(0)かを指定.
} STEPSYNC;
```
#### TIMESYNC
```
typedef struct
{
  DATA8   Cmd;   // 常に0xB1
  DATA8   Nos;   // [^3] なお、立っているビットは丁度2個でなければならない.
  DATA8   Speed; // 到達速度を指定. なお、PWMではない.
  DATA16  Turn;  // 回転率. -200 <= x <= 200. |x| > 100では両方のモータが逆方向に回転する.
  DATA32  Time;  // 走行時間 [msec]
  DATA8   Brake; // ブレーキをかける(1)かそのまま滑走する(0)かを指定.
} TIMESYNC;
```

[^2]: toppersのev3api実装に基づく。正確でない可能性がある。
[^3]: `0b0001`=A、`0b0010`=B、`0b0100`=C、`0b1000`=D
[^5]: `0`ならばモータの回転方向を逆にし、`1`か`-1`ならば回転方向を指定する。それ以外の値は致命的な挙動を引き起こす可能性がある。
[^6]: open-loop制御を行う、ソフトウェア上のモード。
[^7]: PID制御を用いてclosed-loop制御を行う、ソフトウェア上のモード。
